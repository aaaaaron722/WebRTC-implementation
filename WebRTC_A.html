<!DOCTYPE html>
<html>
<head>
  <title>WebRTC A</title>
</head>
<body>
  <h1>WebRTC A ç«¯</h1>

  <textarea id="offer" cols="80" rows="10" placeholder="é€™é‚Šæœƒç”¢ç”Ÿ Offer"></textarea><br>
  <button onclick="createOffer()">å»ºç«‹é€£ç·š</button><br><br>

  <textarea id="answer" cols="80" rows="10" placeholder="è«‹è²¼ä¸Š B çš„ Answer"></textarea><br>
  <button onclick="setAnswer()">è¨­å®š Answer</button><br><br>

  <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯">
  <button onclick="sendMessage()">å‚³é€è¨Šæ¯</button><br><br>

  <p id="status">ç‹€æ…‹ï¼šå°šæœªå»ºç«‹é€£ç·š</p>
  <h3>æ”¶åˆ°çš„è¨Šæ¯ï¼š</h3>
  <div id="messages" style="white-space: pre-wrap;"></div>

  <script>
    const config = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };
    const localConnection = new RTCPeerConnection(config);
    let sendChannel;

    const statusText = document.getElementById("status");

    localConnection.onicecandidate = e => {
      if (!e.candidate) {
        document.getElementById("offer").value = JSON.stringify(localConnection.localDescription);
      }
    };

    function createOffer() {
      sendChannel = localConnection.createDataChannel("sendChannel");

      sendChannel.onopen = () => {
        console.log("DataChannel opened");
        statusText.textContent = "ç‹€æ…‹ï¼šé€£ç·šæˆåŠŸ âœ…";
      };

      sendChannel.onclose = () => {
        console.log("DataChannel closed");
        statusText.textContent = "ç‹€æ…‹ï¼šé€£ç·šé—œé–‰ âŒ";
      };

      sendChannel.onerror = (e) => {
        console.error("DataChannel éŒ¯èª¤ï¼š", e);
        statusText.textContent = "ç‹€æ…‹ï¼šé€£ç·šéŒ¯èª¤ â—";
      };

      sendChannel.onmessage = e => {
        document.getElementById("messages").textContent += "ğŸ‘‚ æ”¶åˆ°: " + e.data + "\n";
      };

      localConnection.createOffer()
        .then(offer => localConnection.setLocalDescription(offer))
        .catch(err => {
          console.error("å»ºç«‹ Offer å¤±æ•—ï¼š", err);
          statusText.textContent = "ç‹€æ…‹ï¼šå»ºç«‹ Offer å¤±æ•— â—";
        });
    }

    function setAnswer() {
      const answer = JSON.parse(document.getElementById("answer").value);
      localConnection.setRemoteDescription(answer)
        .then(() => {
          console.log("Answer å·²è¨­å®š");
          statusText.textContent = "ç‹€æ…‹ï¼šç­‰å¾… DataChannel é–‹å•Ÿä¸­â€¦";
        })
        .catch(err => {
          console.error("è¨­å®š Answer å¤±æ•—ï¼š", err);
          statusText.textContent = "ç‹€æ…‹ï¼šè¨­å®š Answer å¤±æ•— âŒ";
        });
    }

    function sendMessage() {
      const msg = document.getElementById("messageInput");
      if (sendChannel && sendChannel.readyState === "open") {
        sendChannel.send(msg.value);
        document.getElementById("messages").textContent += "ğŸ§‘â€ğŸ’» ç™¼é€: " + msg.value + "\n";
        msg.value = "";
      } else {
        alert("DataChannel å°šæœªé–‹å•Ÿï¼");
      }
    }
  </script>
</body>
</html>
